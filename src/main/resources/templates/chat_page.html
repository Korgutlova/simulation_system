<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Common chat</title>
    <link type="text/css"
          href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
          rel="stylesheet">
    <link rel="stylesheet"
          href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.4.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
<div th:insert="~{header :: header-block}"></div>
<main role="main" class="container" style="max-width: 1700px;">
    <div class="row">
        <div class="col-md-3">
            <div class="header_chat">
                <h4>Chats</h4>
                <hr>
                <div id="chats-panel" class="overflow-auto"
                     style="height: 500px">
                    <ul class="chats" style="list-style-type:none">
                        <!--<li class="chat-item" style="list-style-type:none" th:each="c : ${chats}"-->
                        <!--th:id="'chat_' + ${c.getId()}">-->
                        <li>
                            <div><a style="text-decoration: none"
                                    th:href="@{/chat(id=1)}">
                                <p th:id="${bot.getId()}" th:text="${bot.getUser().getFirstAndLastName()}">..</p>
                            </a>
                            </div>
                            <hr>
                        </li>
                        <li>
                            <!--<div><a style="text-decoration: none" th:href="@{/room(id=${c.getId()})}">-->
                            <div><a style="text-decoration: none"
                                    th:href="@{/chat(id=2)}">
                                <p th:id="${bot.getId()}" th:text="${bot.getUser().getFirstAndLastName()}">..</p>
                            </a>
                            </div>
                            <hr>
                        </li>
                        <!--</li>-->
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-md-7">
            <div class="header_chat">
                <h4 th:text="${bot.getNameWithRole()}">..</h4>
                <hr>
            </div>
            <div class="overflow-auto" style="height: 500px" id="messages">
                <ul class="messages"
                    style="list-style-type:none; margin-top: 20px">
                    <!--<li class="message-item"-->
                    <!--th:each="m : ${current_chat.getMessages()}"-->
                    <!--th:id="'m_' + ${m.getId()}"-->
                    <!--th:if="${m.isSimple() || m.isInformation()}">-->
                    <li class="message-item">
                        <div class="card container"
                             style="padding-left: 8px; padding-top: 5px; line-height: 1">
                             <!--th:if="${m.isSimple()}">-->
                            <div class="row">
                                <div class="col-9">
                                    <p th:text="'Привет как дела???'">Text</p>
                                </div>
                                <div class="col-3" style="text-align: right;">
                                    <!--<p th:if="${user.isModerator()or user.isAdmin()}"-->
                                    <!--style="font-size: 25px; color: #9d0000"-->
                                    <!--class="del_message">-->
                                    <!--<i class="fa fa-times"></i></p>-->
                                    <!--<p th:text="${#temporals.format(m.getDateTime(), 'HH:mm:ss dd.MM.YY')}"-->
                                    <!--style="color: gray;">Data</p>-->
                                    <p th:text="'16:10:30 05.04.21'"
                                       style="color: gray;">Data</p>
                                </div>
                            </div>
                        </div>
                        <br>
                    </li>
                    <!--</li>-->
                </ul>

            </div>
            <hr>
            <div class="panel-footer">
                <div class=" row" style=" margin-left: 60px">
                    <div class="col-md-8">
            <textarea name="text" id="message" cols="70" rows="2"
                      class="form-control"
                      placeholder="Enter your message..."></textarea>
                    </div>
                    <div class="col-md-3">
                        <input class="btn btn-info"
                               style="width: 150px"
                               type="submit" id="custombtn" value="Send">
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
</body>
<script th:inline="javascript">
    var ws;
    var stompClient;
    $(document).ready(function () {
        $("#messages").scrollTop(1E10);
        $('#custombtn').click(function () {
            var message = $('#message');
            if (message.val().length > 500) {
                alert("Message length exceeds 500 characters");
            } else {
                sendForm();
                message.val('');
            }
        });

        // $('.messages').on('click', '.del_message', function () {
        //     deleteForm($(this).parent().parent().parent().parent().attr("id"));
        // });

        ws = new SockJS('/ws');
        stompClient = Stomp.over(ws);
        stompClient.connect({}, function () {
            var addressRoom = '/queue/bot/' + [[${bot.getId()}]];
            var addressConvUser = addressRoom + '/user/' + [[${user.getId()}]];
            stompClient.subscribe(addressConvUser, function (message) {
                var m = JSON.parse(message.body);
                alert(m.text);
            });
        }, function (error) {
            console.log("STOMP protocol error " + error);
        });

    });

    function sendForm() {
        var text = $('#message').val();
        if (text != null && (text.trim().length > 0)) {
            var sendAddress = '/app/bot/send/' + [[${bot.getId()}]];
            var userObj = /*[[${user}]]*/ {};
            stompClient.send(sendAddress, {}, JSON.stringify({
                text: text,
                user: userObj
            }));
        } else {
            alert("Cannot send an empty message");
        }
    }
</script>
</html>